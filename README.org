* cups-email

This is a fork of the old [[https://sourceforge.net/projects/cupsemailptr/][cupsemailptr]], which is a variant of [[http://vigna.di.unimi.it/fax4CUPS/][fax4CUPS]]. Improvements include:

- configuration options through the cups server, allowing easy queue-specific configurations
- using a SMTP server instead of local sendmail
- free-form parameters (like to address) through the graphical print dialogue
- significantly better error handling and reporting

** Breaking changes after version 0.1

Improvements after release 0.1 introduced many breaking changes. Please go through the configuration guide below again when upgrading. The breaking changes are mainly:

- installation sanity checking now happens at the time of printing, not at the time of adding a printer.
- global and queue specific configuration files in the cups root are no longer read.
- only a subset of mailx variables can be directly configured, and no variables can be added. This means that for complex configurations a mailxrc is now mandatory.
- the option names have changed. Existing wrappers around lpr will need to be adjusted.
- source for email address is no longer a user changeable option
- email address source no longer allows option overrides when set to a specific source

** Installation

This printer drivers consists of two files, the post script printer definition (email.ppd) and the backend script (email). The PPD needs to be installed to the cups model directory (usually =/usr/share/cups/model=), the script to the cups backend directory (usually =/usr/lib/cups/backend=).

The easiest way to install is using the included Makefile. The following variables can be overridden:

- CUPS_PPD_DIR (/usr/share/cups/model)
- CUPS_BACKEND_DIR (/usr/lib/cups/backend)
- PS2PDF (/usr/bin/epstopdf)
- MAILX (/usr/bin/mailx)

Overrides to =PS2PDF= and =MAILX= also adjust the default path in the installed PPD.

** Configuration
*** Adding a printer

**** Adding through CLI

First the installation should be verified using =lpinfo=:

#+BEGIN_SRC sh
# lpinfo -m|grep -i email
email.ppd email
#+END_SRC

Now a printer can be added using =lpadmin=:

#+BEGIN_SRC sh
# lpadmin -p email-sample -E -v email:/sample -D 'Sample email printer' -L 'Printer location' -m email.ppd
#+END_SRC

Finally printer options can be set. A complete list of available options can be listed through =lpoptions=:

#+BEGIN_SRC sh
lpoptions -p email-sample -l

#+END_SRC

At least the =MailFrom= needs to be configured. Values for custom strings need to be prefixed with =Custom.= when set through =lpadmin=:

#+BEGIN_SRC sh
# lpadmin -p email-sample -E -o MailFrom=Custom.printer@example.com
#+END_SRC

Most installations also will need to set the =mailx_smtp= option for the SMTP server. A more complicated example using SMTP-AUTH is below.

**** Adding through the web interface
After successful installation a new printer called =E-Mail Device= should be available when adding new printers:

#+CAPTION: Selecting printer
[[./img/backend_select.png]]

The connection URI for the printer should be =email:/<queue>=:

#+CAPTION: Configure printer URI
[[./img/connection_select.png]]

Select =email= as printer driver for this new printer:

#+CAPTION: Configure printer driver
[[./img/driver_select.png]]

*** Configuration variables

All variables can be used in both global and queue specific files. If they're specified in both locations the queue specific value overrides the global one.

**** MAILCMD
The full path to a  [[http://heirloom.sourceforge.net/mailx.html][modern mailx variant]]
**** PS2PDF
The full path to =epstopdf=, nowadays commonly shipped with =texlive=
**** MAILTEXT
The text contained in the body of the e-mail
**** FROM
The from address to use for sending mails
**** TO
The location for getting the send-to address. Valid values are =-j= for using the job name and =-u= for using the user name.

Unless sending through a local sendmail the user name is most likely useless without a mail domain. If a =DEFAULTDOMAIN= variable is set =<user>@$DEFAULTDOMAIN= will be used as address.

Explicitely setting the to address via options - either as =-o ToAddress=<user@example.com>= or via the print dialogue - will override this setting.
**** MAILRC
The location of the mailrc file, defaulting to =/dev/null=

**** MAILX_VARS
A list of variables understood by mailx (see the mailx man page), which will be exported (and therefore made available to mailx). The default list is ="from ORGANIZATION replyto sender sendwait signature smtp MAILRC"=.

Any of those variables may be used in the configuration file. Most useful is the =smtp= variable, allowing sending via a SMTP server instead of local sendmail.
*** Example configuration for gmail

To use gmail as mail server [[https://myaccount.google.com/lesssecureapps]["less secure app access"]] needs to be enabled on the gmail account. After that a mailrc (with secure permissions!) can be added, for example to =/etc/cups/mailrc.gmail=:

#+BEGIN_SRC sh
set smtp-use-starttls
set ssl-verify=ignore
set smtp=smtp://smtp.gmail.com:587
set smtp-auth=login
set smtp-auth-user=your-mail-address
set smtp-auth-password=your-password
#+END_SRC

lpadmin -p email-printer -E -o mailx_MAILRC=Custom./etc/cups/mailrc.gmail

** Printing

# lpstat -p email-sample
printer email-sample disabled since Sat May  9 10:54:20 2020 -
	MailFrom is not defined


* References
- [[https://www.cups.org/doc/api-filter.html][CUPS backend documentation]]
- [[https://wiki.linuxfoundation.org/en/OpenPrinting/PPDExtensions#Custom_Options][OpenPrinting about custom PPD extensions]]
- [[https://www.cups.org/doc/spec-ppd.html#OPTIONS][CUPS specific PPD extensions]]
